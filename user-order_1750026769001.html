<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø·Ù„Ø¨ ØªÙˆØµÙŠÙ„ - Ø·ÙŠØ§Ø±</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 15px;
      max-width: 100%;
      margin: 0;
      background: #e7f0ff;
      direction: rtl;
      box-sizing: border-box;
    }
    
    /* ØªØ­Ø³ÙŠÙ† Ù„Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø© */
    @media (min-width: 768px) {
      body {
        padding: 20px;
        max-width: 500px;
        margin: auto;
      }
    }
    
    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      
      h2 {
        font-size: 20px;
        margin: 10px 0;
      }
      
      input, textarea {
        font-size: 16px; /* Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ¨ÙŠØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ iOS */
      }
      
      button {
        font-size: 16px;
        padding: 12px;
      }
      
      .location-btn {
        font-size: 13px;
        padding: 8px 12px;
      }
    }
    h2 {
      text-align: center;
      color: #004080;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 15px;
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    button {
      margin-top: 15px;
      background: #0077cc;
      color: white;
      border: none;
      padding: 14px;
      font-size: 18px;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
    }
    button:hover {
      background: #005a99;
    }
    button:active {
      background: #004080;
    }
    .price-display {
      margin-top: 10px;
      font-weight: bold;
      font-size: 18px;
      color: #004080;
      text-align: center;
      background: #f0f8ff;
      padding: 10px;
      border-radius: 6px;
    }
    .location-section {
      background: #f8f9fa;
      padding: 15px;
      margin: 15px 0;
      border-radius: 8px;
      border: 2px solid #0077cc;
    }
    .location-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 15px;
      margin: 5px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      width: calc(50% - 10px);
    }
    .location-btn:hover {
      background: #218838;
    }
    .location-btn.active {
      background: #dc3545;
    }
    .location-info {
      background: #e7f3ff;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      font-size: 14px;
      border: 1px solid #0077cc;
    }
    .distance-info {
      background: #d4edda;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      text-align: center;
      font-weight: bold;
      color: #155724;
      border: 2px solid #28a745;
    }
    .manual-location {
      display: none;
      background: #fff3cd;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      border: 2px solid #ffc107;
    }
    .manual-location.show {
      display: block;
    }
    .coords-input {
      width: calc(50% - 10px);
      margin: 5px;
    }
    .status-msg {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      text-align: center;
      font-weight: bold;
    }
    .success { background: #d4edda; color: #155724; border: 1px solid #28a745; }
    .warning { background: #fff3cd; color: #856404; border: 1px solid #ffc107; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #dc3545; }
    
    /* Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø®Ø±ÙŠØ·Ø© - Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø© */
    .map-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.9);
      z-index: 1000;
    }
    .map-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      border-radius: 0;
      overflow: hidden;
    }
    .map-header {
      background: #0077cc;
      color: white;
      padding: 12px 10px;
      text-align: center;
      font-size: 16px;
      font-weight: bold;
    }
    .map-content {
      height: calc(100vh - 160px);
      position: relative;
    }
    
    /* ØªØ­Ø³ÙŠÙ† Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
    @media (max-width: 768px) {
      .map-header {
        padding: 10px 8px;
        font-size: 14px;
      }
      .map-content {
        height: calc(100vh - 150px);
      }
      .map-controls {
        padding: 10px;
      }
      .map-btn {
        padding: 8px 15px;
        font-size: 14px;
        margin: 0 5px;
      }
    }
    #realMap {
      width: 100%;
      height: 100%;
      border: none;
    }
    .map-controls {
      background: #f8f9fa;
      padding: 15px;
      text-align: center;
      border-top: 2px solid #0077cc;
    }
    .map-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 0 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    .map-btn:hover {
      background: #218838;
    }
    .map-btn.cancel {
      background: #dc3545;
    }
    .map-btn.cancel:hover {
      background: #c82333;
    }
    .selected-location {
      background: #e7f3ff;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      font-size: 14px;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .map-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }
    
    .location-btn:hover {
      transform: translateY(-1px);
      transition: all 0.2s ease;
    }
    
    /* ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« */
    #searchResults div:hover {
      background: #f0f8ff !important;
      border-color: #0077cc !important;
      transform: translateX(-3px);
      transition: all 0.2s ease;
    }
  </style>
</head>
<body>
  <h2>Ø·Ù„Ø¨ ØªÙˆØµÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h2>

  <div class="location-section">
    <h3 style="margin: 0 0 15px 0; color: #004080; text-align: center;">ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</h3>

    <div style="text-align: center; margin-bottom: 15px;">
      <button class="location-btn" id="autoLocationBtn" onclick="useAutoLocation()">
        ğŸŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… GPS Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
      </button>
      <button class="location-btn" id="manualLocationBtn" onclick="useManualLocation()">
        âœï¸ Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ
      </button>
    </div>

    <div id="statusMsg" class="status-msg warning">
      Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø£Ø¹Ù„Ø§Ù‡
    </div>

    <div id="autoLocationSection" style="display: none;">
      <button class="location-btn" id="pickupBtn" onclick="openMapForLocation('pickup')" style="width: 100%;">
        ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
      </button>
      <button class="location-btn" id="deliveryBtn" onclick="openMapForLocation('delivery')" style="width: 100%; margin-top: 10px;">
        ğŸ¯ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
      </button>
      <div style="margin-top: 10px; text-align: center;">
        <button class="location-btn" onclick="getCurrentLocation('pickup')" style="width: 48%; font-size: 14px; padding: 8px;">
          ğŸŒ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ
        </button>
        <button class="location-btn" onclick="getCurrentLocation('delivery')" style="width: 48%; font-size: 14px; padding: 8px; margin-left: 4%;">
          ğŸŒ Ù…ÙˆÙ‚Ø¹ÙŠ Ù„Ù„ØªØ³Ù„ÙŠÙ…
        </button>
      </div>
    </div>

    <div id="manualLocationSection" class="manual-location">
      <h4>Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ ÙŠØ¯ÙˆÙŠØ§Ù‹:</h4>
      <div>
        <label>Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…:</label>
        <input type="text" id="manualPickupAddress" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…">
        <div style="margin-top: 5px;">
          <input type="number" id="manualPickupLat" class="coords-input" placeholder="Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶" step="any">
          <input type="number" id="manualPickupLng" class="coords-input" placeholder="Ø®Ø· Ø§Ù„Ø·ÙˆÙ„" step="any">
        </div>
      </div>
      <div style="margin-top: 15px;">
        <label>Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ³Ù„ÙŠÙ…:</label>
        <input type="text" id="manualDeliveryAddress" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªØ³Ù„ÙŠÙ…">
        <div style="margin-top: 5px;">
          <input type="number" id="manualDeliveryLat" class="coords-input" placeholder="Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶" step="any">
          <input type="number" id="manualDeliveryLng" class="coords-input" placeholder="Ø®Ø· Ø§Ù„Ø·ÙˆÙ„" step="any">
        </div>
      </div>
      <button onclick="calculateManualDistance()" style="width: 100%; margin-top: 15px; background: #28a745;">
        Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© ÙˆØ§Ù„Ø³Ø¹Ø±
      </button>
    </div>
  </div>

  <div class="location-info" id="pickupInfo">Ù…ÙƒØ§Ù† Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…: ØºÙŠØ± Ù…Ø­Ø¯Ø¯</div>
  <div class="location-info" id="deliveryInfo">Ù…ÙƒØ§Ù† Ø§Ù„ØªØ³Ù„ÙŠÙ…: ØºÙŠØ± Ù…Ø­Ø¯Ø¯</div>
  <div class="distance-info" id="distanceInfo">Ø§Ù„Ù…Ø³Ø§ÙØ©: ØºÙŠØ± Ù…Ø­Ø³ÙˆØ¨Ø©</div>

  <label for="pickup">Ù…ÙƒØ§Ù† Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… (Ø§Ù„Ø¹Ù†ÙˆØ§Ù†):</label>
  <input type="text" id="pickup" placeholder="Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹" readonly />

  <!-- ØªÙØ§ØµÙŠÙ„ Ù…ÙƒØ§Ù† Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… -->
  <div style="background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px; border: 1px solid #ddd;">
    <h4 style="margin: 0 0 10px 0; color: #0077cc;">ğŸ“ ØªÙØ§ØµÙŠÙ„ Ù…ÙƒØ§Ù† Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</h4>
    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
      <input type="number" id="pickupFloor" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¯ÙˆØ±" style="flex: 1; min-width: 0;" />
      <input type="number" id="pickupApartment" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø´Ù‚Ø©" style="flex: 1; min-width: 0;" />
    </div>
    <input type="text" id="pickupDetails" placeholder="Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ù„ÙˆÙ† Ø§Ù„Ø¹Ù…Ø§Ø±Ø©ØŒ Ø¹Ù„Ø§Ù…Ø© Ù…Ù…ÙŠØ²Ø©ØŒ Ø¥Ù„Ø®...)" style="width: 100%;" />
  </div>

  <label for="delivery">Ù…ÙƒØ§Ù† Ø§Ù„ØªØ³Ù„ÙŠÙ… (Ø§Ù„Ø¹Ù†ÙˆØ§Ù†):</label>
  <input type="text" id="delivery" placeholder="Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹" readonly />

  <!-- ØªÙØ§ØµÙŠÙ„ Ù…ÙƒØ§Ù† Ø§Ù„ØªØ³Ù„ÙŠÙ… -->
  <div style="background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px; border: 1px solid #ddd;">
    <h4 style="margin: 0 0 10px 0; color: #0077cc;">ğŸ¯ ØªÙØ§ØµÙŠÙ„ Ù…ÙƒØ§Ù† Ø§Ù„ØªØ³Ù„ÙŠÙ…</h4>
    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
      <input type="number" id="deliveryFloor" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¯ÙˆØ±" style="flex: 1; min-width: 0;" />
      <input type="number" id="deliveryApartment" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø´Ù‚Ø©" style="flex: 1; min-width: 0;" />
    </div>
    <input type="text" id="deliveryDetails" placeholder="Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ù„ÙˆÙ† Ø§Ù„Ø¹Ù…Ø§Ø±Ø©ØŒ Ø¹Ù„Ø§Ù…Ø© Ù…Ù…ÙŠØ²Ø©ØŒ Ø¥Ù„Ø®...)" style="width: 100%;" />
  </div>

  <label for="description">ÙˆØµÙ Ø§Ù„Ø·Ù„Ø¨:</label>
  <textarea id="description" placeholder="ØµÙ Ù…Ø§ ØªØ±ÙŠØ¯ ØªÙˆØµÙŠÙ„Ù‡"></textarea>

  <div class="price-display" id="priceDisplay">Ø§Ù„Ø³Ø¹Ø±: 0 Ø¬Ù†ÙŠÙ‡</div>

  <button id="sendOrderBtn" onclick="sendOrder()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>

  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
  <div id="mapModal" class="map-modal">
    <div class="map-container">
      <div class="map-header" id="mapHeader">
        Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ø­Ø«
      </div>
      
      <!-- Ø®Ø§Ù†Ø© Ø§Ù„Ø¨Ø­Ø« - Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø© -->
      <div style="padding: 8px; background: #f8f9fa; border-bottom: 2px solid #0077cc;">
        <div style="display: flex; flex-wrap: wrap; gap: 5px; align-items: center;">
          <input type="text" id="searchLocation" 
                 placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙƒØ§Ù†..." 
                 style="flex: 1; min-width: 200px; padding: 10px 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px;">
          <button onclick="searchForLocation()" 
                  style="background: #007bff; color: white; border: none; padding: 10px 12px; border-radius: 5px; cursor: pointer; font-size: 14px; white-space: nowrap;">
            ğŸ”
          </button>
          <button id="quickConfirmBtn" onclick="quickConfirmLocation()" 
                  style="background: #28a745; color: white; border: none; padding: 10px 12px; border-radius: 5px; cursor: pointer; font-size: 14px; display: none; white-space: nowrap;">
            âœ…
          </button>
        </div>
        <div id="searchResults" style="margin-top: 8px; display: none; max-height: 150px; overflow-y: auto;">
          <!-- Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
        </div>
      </div>
      
      <div class="map-content">
        <div id="realMap"></div>
      </div>
      <div id="selectedLocationInfo" class="selected-location" style="display: none;">
        Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯: Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø¨Ø¹Ø¯
      </div>
      <div class="map-controls">
        <button class="map-btn" id="confirmLocationBtn" onclick="confirmLocation()" style="display: none; background: #28a745; font-size: 16px; padding: 12px 20px; width: auto; min-width: 120px;">
          âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
        </button>
        <button class="map-btn cancel" onclick="closeMap()" style="width: auto; min-width: 80px;">
          âŒ Ø¥Ù„ØºØ§Ø¡
        </button>
      </div>
    </div>
  </div>

  <script>
    let pickupLocation = null;
    let deliveryLocation = null;
    let isDeliverySelectionEnabled = false;
    let currentMapMode = null; // 'pickup' or 'delivery'
    let selectedMapLocation = null;
    let map = null;
    let currentMarker = null;

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    function useAutoLocation() {
      document.getElementById('autoLocationSection').style.display = 'block';
      document.getElementById('manualLocationSection').classList.remove('show');
      document.getElementById('autoLocationBtn').classList.add('active');
      document.getElementById('manualLocationBtn').classList.remove('active');
      updateStatus('success', 'âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… GPS Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ');
    }

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ
    function useManualLocation() {
      document.getElementById('autoLocationSection').style.display = 'none';
      document.getElementById('manualLocationSection').classList.add('show');
      document.getElementById('manualLocationBtn').classList.add('active');
      document.getElementById('autoLocationBtn').classList.remove('active');
      updateStatus('success', 'âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ');
    }

    // ØªØ­Ø¯ÙŠØ« Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø­Ø§Ù„Ø©
    function updateStatus(type, message) {
      const statusMsg = document.getElementById('statusMsg');
      statusMsg.className = `status-msg ${type}`;
      statusMsg.textContent = message;
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
    function getCurrentLocation(type) {
      if (!navigator.geolocation) {
        updateStatus('error', 'âŒ Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø®Ø¯Ù…Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ GPS');
        return;
      }

      updateStatus('warning', 'â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ... ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±');

      const button = type === 'pickup' ? document.getElementById('pickupBtn') : null;
      if (button) {
        button.textContent = 'â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...';
        button.disabled = true;
      }

      navigator.geolocation.getCurrentPosition(
        function(position) {
          const location = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };

          if (type === 'pickup') {
            pickupLocation = location;
            document.getElementById('pickup').value = `Ù…ÙˆÙ‚Ø¹ GPS: ${location.lat.toFixed(6)}, ${location.lng.toFixed(6)}`;
            document.getElementById('pickupInfo').textContent = `âœ… Ù…ÙƒØ§Ù† Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…: ØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡ Ø¨ÙˆØ§Ø³Ø·Ø© GPS`;
            document.getElementById('pickupBtn').textContent = 'âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…';
            document.getElementById('pickupBtn').style.background = '#28a745';
            updateStatus('success', 'âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­!');
          } else if (type === 'delivery') {
            deliveryLocation = location;
            document.getElementById('delivery').value = `Ù…ÙˆÙ‚Ø¹ GPS: ${location.lat.toFixed(6)}, ${location.lng.toFixed(6)}`;
            document.getElementById('deliveryInfo').textContent = `âœ… Ù…ÙƒØ§Ù† Ø§Ù„ØªØ³Ù„ÙŠÙ…: ØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡ Ø¨ÙˆØ§Ø³Ø·Ø© GPS`;
            document.getElementById('deliveryBtn').textContent = 'âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ³Ù„ÙŠÙ…';
            document.getElementById('deliveryBtn').style.background = '#28a745';
            updateStatus('success', 'âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­!');
          }
          
          // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¥Ø°Ø§ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ÙŠÙ†
          if (pickupLocation && deliveryLocation) {
            calculateDistance();
          }

          if (button) button.disabled = false;
        },
        function(error) {
          let errorMessage = 'ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ: ';
          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMessage += 'ØªÙ… Ø±ÙØ¶ Ø¥Ø°Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMessage += 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªØ§Ø­Ø©';
              break;
            case error.TIMEOUT:
              errorMessage += 'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
              break;
            default:
              errorMessage += 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
              break;
          }

          updateStatus('error', 'âŒ ' + errorMessage);

          if (button) {
            button.textContent = 'ğŸ”„ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
            button.disabled = false;
          }
        },
        {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 300000
        }
      );
    }

    // ÙØªØ­ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
    function openMapForLocation(type) {
      currentMapMode = type;
      selectedMapLocation = null;
      
      const modal = document.getElementById('mapModal');
      const header = document.getElementById('mapHeader');
      const selectedInfo = document.getElementById('selectedLocationInfo');
      const confirmBtn = document.getElementById('confirmLocationBtn');
      
      if (type === 'pickup') {
        header.textContent = 'ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… - Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©';
      } else {
        header.textContent = 'ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ³Ù„ÙŠÙ… - Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©';
      }
      
      selectedInfo.style.display = 'none';
      confirmBtn.style.display = 'none';
      
      modal.style.display = 'block';
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
      setTimeout(() => {
        createRealMap();
      }, 100);
      
      updateStatus('warning', 'ğŸ“ Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹');
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø±ÙŠØ·Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Leaflet
    function createRealMap() {
      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª
      if (map) {
        map.remove();
        map = null;
      }
      
      // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ© - Ø£ÙˆÙ„Ø§Ù‹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ø£Ùˆ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£Ùˆ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©
      let initialLat = 30.0444;
      let initialLng = 31.2357;
      let initialZoom = 10;
      
      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…ÙˆÙ‚Ø¹ Ù…Ø­Ø¯Ø¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹ØŒ Ø§Ø³ØªØ®Ø¯Ù…Ù‡
      if (currentMapMode === 'pickup' && pickupLocation) {
        initialLat = pickupLocation.lat;
        initialLng = pickupLocation.lng;
        initialZoom = 15;
      } else if (currentMapMode === 'delivery' && deliveryLocation) {
        initialLat = deliveryLocation.lat;
        initialLng = deliveryLocation.lng;
        initialZoom = 15;
      }
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø±ÙŠØ·Ø© Ø¬Ø¯ÙŠØ¯Ø©
      map = L.map('realMap').setView([initialLat, initialLng], initialZoom);
      
      // Ø¥Ø¶Ø§ÙØ© Ø·Ø¨Ù‚Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ù† OpenStreetMap
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(map);
      
      // Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ø¥Ù† ÙˆØ¬Ø¯
      if ((currentMapMode === 'pickup' && pickupLocation) || (currentMapMode === 'delivery' && deliveryLocation)) {
        const existingLocation = currentMapMode === 'pickup' ? pickupLocation : deliveryLocation;
        currentMarker = L.marker([existingLocation.lat, existingLocation.lng])
          .addTo(map)
          .bindPopup(`Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹: ${existingLocation.lat.toFixed(6)}, ${existingLocation.lng.toFixed(6)}`)
          .openPopup();
        
        selectedMapLocation = existingLocation;
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯ ÙÙˆØ±Ø§Ù‹ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹
        setTimeout(() => {
          showLocationConfirmation();
        }, 200);
      } else {
        // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…ÙˆÙ‚Ø¹ Ù…Ø­Ø¯Ø¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function(position) {
              const lat = position.coords.latitude;
              const lng = position.coords.longitude;
              
              // Ø¥Ø°Ø§ Ù„Ù… Ù†ÙƒÙ† Ù‚Ø¯ Ø­Ø¯Ø¯Ù†Ø§ Ù…ÙˆÙ‚Ø¹ Ù…Ø³Ø¨Ù‚Ø§Ù‹ØŒ Ø§Ù†ØªÙ‚Ù„ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
              if (!((currentMapMode === 'pickup' && pickupLocation) || (currentMapMode === 'delivery' && deliveryLocation))) {
                map.setView([lat, lng], 15);
                
                // Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø© Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
                L.marker([lat, lng])
                  .addTo(map)
                  .bindPopup('Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ - Ø§Ù†Ù‚Ø± Ù‡Ù†Ø§ Ù„ØªØ­Ø¯ÙŠØ¯Ù‡ Ø£Ùˆ Ø§Ù†Ù‚Ø± ÙÙŠ Ù…ÙƒØ§Ù† Ø¢Ø®Ø±')
                  .openPopup();
              }
            },
            function(error) {
              console.log('ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ:', error);
            }
          );
        }
      }
      
      // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
      map.on('click', function(e) {
        selectLocationOnRealMap(e.latlng);
      });
    }

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆÙ‚Ø¹
    function searchForLocation() {
      const searchTerm = document.getElementById('searchLocation').value.trim();
      if (!searchTerm) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù† Ù„Ù„Ø¨Ø­Ø«');
        return;
      }
      
      // Ø§Ø³ØªØ®Ø¯Ø§Ù… Nominatim API Ù„Ù„Ø¨Ø­Ø« (Ù…Ø¬Ø§Ù†ÙŠ)
      const searchUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchTerm + ' Ù…ØµØ±')}&limit=5&accept-language=ar`;
      
      fetch(searchUrl)
        .then(response => response.json())
        .then(data => {
          displaySearchResults(data);
        })
        .catch(error => {
          console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«:', error);
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
        });
    }

    // Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
    function displaySearchResults(results) {
      const resultsContainer = document.getElementById('searchResults');
      
      if (!results || results.length === 0) {
        resultsContainer.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 10px;">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬</div>';
        resultsContainer.style.display = 'block';
        return;
      }
      
      let resultsHTML = '<div style="color: #0077cc; font-weight: bold; margin-bottom: 5px;">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«:</div>';
      
      results.forEach((result, index) => {
        resultsHTML += `
          <div onclick="selectSearchResult(${result.lat}, ${result.lon}, '${result.display_name.replace(/'/g, "\\'")}')" 
               style="background: white; margin: 3px 0; padding: 8px; border: 1px solid #ddd; border-radius: 3px; cursor: pointer; font-size: 13px;">
            ğŸ“ ${result.display_name}
          </div>
        `;
      });
      
      resultsContainer.innerHTML = resultsHTML;
      resultsContainer.style.display = 'block';
    }

    // Ø§Ø®ØªÙŠØ§Ø± Ù†ØªÙŠØ¬Ø© Ù…Ù† Ø§Ù„Ø¨Ø­Ø«
    function selectSearchResult(lat, lng, displayName) {
      // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
      map.setView([lat, lng], 16);
      
      // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
      const latlng = { lat: parseFloat(lat), lng: parseFloat(lng) };
      selectLocationOnRealMap(latlng);
      
      // Ø¥Ø®ÙØ§Ø¡ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
      document.getElementById('searchResults').style.display = 'none';
      document.getElementById('searchLocation').value = displayName.split(',')[0]; // Ø£ÙˆÙ„ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø§Ø³Ù…
    }

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
    function selectLocationOnRealMap(latlng) {
      selectedMapLocation = { lat: latlng.lat, lng: latlng.lng };
      
      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
      if (currentMarker) {
        map.removeLayer(currentMarker);
      }
      
      // Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…Ù…ÙŠØ²Ø©
      currentMarker = L.marker([latlng.lat, latlng.lng])
        .addTo(map)
        .bindPopup(`
          <div style="text-align: center;">
            <strong>Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯</strong><br>
            ğŸ“ ${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}<br>
            <small style="color: #666;">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ "ØªØ£ÙƒÙŠØ¯ ÙˆØ­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹" Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</small>
          </div>
        `)
        .openPopup();
      
      // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯ ÙÙˆØ±Ø§Ù‹
      const selectedInfo = document.getElementById('selectedLocationInfo');
      const confirmBtn = document.getElementById('confirmLocationBtn');
      
      selectedInfo.innerHTML = `
        <div style="text-align: center;">
          âœ… <strong>ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­!</strong><br>
          ğŸ“ ${selectedMapLocation.lat.toFixed(6)}, ${selectedMapLocation.lng.toFixed(6)}<br>
          <small style="color: #666;">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªØ£ÙƒÙŠØ¯ ÙˆØ­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹" Ù„Ø­ÙØ¸ Ø§Ø®ØªÙŠØ§Ø±Ùƒ</small>
        </div>
      `;
      selectedInfo.style.display = 'block';
      selectedInfo.style.background = '#d4edda';
      selectedInfo.style.border = '2px solid #28a745';
      selectedInfo.style.animation = 'pulse 1s ease-in-out';
      
      confirmBtn.style.display = 'inline-block';
      confirmBtn.style.animation = 'pulse 1s ease-in-out';
      
      // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø±ÙŠØ¹ ÙÙŠ Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø«
      const quickConfirmBtn = document.getElementById('quickConfirmBtn');
      quickConfirmBtn.style.display = 'inline-block';
      quickConfirmBtn.style.animation = 'pulse 1s ease-in-out';
    }

    // ØªØ£ÙƒÙŠØ¯ Ø³Ø±ÙŠØ¹ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø«
    function quickConfirmLocation() {
      if (!selectedMapLocation || !currentMapMode) {
        alert('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹!');
        return;
      }
      
      // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ù…Ù†Ø·Ù‚ confirmLocation
      confirmLocation();
    }

    // Ø¥Ø¸Ù‡Ø§Ø± ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
    function showLocationConfirmation() {
      const selectedInfo = document.getElementById('selectedLocationInfo');
      const confirmBtn = document.getElementById('confirmLocationBtn');
      
      if (selectedMapLocation) {
        selectedInfo.innerHTML = `
          <div style="text-align: center;">
            âœ… <strong>ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­!</strong><br>
            ğŸ“ ${selectedMapLocation.lat.toFixed(6)}, ${selectedMapLocation.lng.toFixed(6)}<br>
            <small style="color: #666;">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªØ£ÙƒÙŠØ¯ ÙˆØ­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹" Ù„Ø­ÙØ¸ Ø§Ø®ØªÙŠØ§Ø±Ùƒ</small>
          </div>
        `;
        selectedInfo.style.display = 'block';
        selectedInfo.style.background = '#d4edda';
        selectedInfo.style.border = '2px solid #28a745';
        selectedInfo.style.animation = 'pulse 1s ease-in-out';
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø¨Ø´ÙƒÙ„ ÙˆØ§Ø¶Ø­
        confirmBtn.style.display = 'inline-block';
        confirmBtn.style.visibility = 'visible';
        confirmBtn.style.opacity = '1';
        confirmBtn.disabled = false;
        confirmBtn.style.animation = 'pulse 1s ease-in-out';
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø±ÙŠØ¹ Ø£ÙŠØ¶Ø§Ù‹
        const quickConfirmBtn = document.getElementById('quickConfirmBtn');
        quickConfirmBtn.style.display = 'inline-block';
        quickConfirmBtn.style.animation = 'pulse 1s ease-in-out';
        
        console.log('ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯'); // Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ´ØºÙŠÙ„
      }
    }

    // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯
    function confirmLocation() {
      if (!selectedMapLocation || !currentMapMode) {
        alert('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹!');
        return;
      }
      
      // ØªØ£Ø«ÙŠØ± ØªØ£ÙƒÙŠØ¯ Ø¨ØµØ±ÙŠ
      const confirmBtn = document.getElementById('confirmLocationBtn');
      confirmBtn.textContent = 'âœ… Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
      confirmBtn.disabled = true;
      
      setTimeout(() => {
        if (currentMapMode === 'pickup') {
          pickupLocation = selectedMapLocation;
          
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
          const searchValue = document.getElementById('searchLocation').value;
          const locationText = searchValue || `Ù…ÙˆÙ‚Ø¹ Ø®Ø±ÙŠØ·Ø©: ${selectedMapLocation.lat.toFixed(6)}, ${selectedMapLocation.lng.toFixed(6)}`;
          
          document.getElementById('pickup').value = locationText;
          document.getElementById('pickupInfo').innerHTML = `âœ… <strong>Ù…ÙƒØ§Ù† Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…:</strong> ØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ù†Ø¬Ø§Ø­`;
          
          const pickupBtn = document.getElementById('pickupBtn');
          pickupBtn.textContent = 'âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… - Ø§Ù†Ù‚Ø± Ù„Ù„ØªØ¹Ø¯ÙŠÙ„';
          pickupBtn.style.background = '#28a745';
          
          updateStatus('success', 'âœ… ØªÙ… Ø­ÙØ¸ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­!');
          
        } else if (currentMapMode === 'delivery') {
          deliveryLocation = selectedMapLocation;
          
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
          const searchValue = document.getElementById('searchLocation').value;
          const locationText = searchValue || `Ù…ÙˆÙ‚Ø¹ Ø®Ø±ÙŠØ·Ø©: ${selectedMapLocation.lat.toFixed(6)}, ${selectedMapLocation.lng.toFixed(6)}`;
          
          document.getElementById('delivery').value = locationText;
          document.getElementById('deliveryInfo').innerHTML = `âœ… <strong>Ù…ÙƒØ§Ù† Ø§Ù„ØªØ³Ù„ÙŠÙ…:</strong> ØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ù†Ø¬Ø§Ø­`;
          
          const deliveryBtn = document.getElementById('deliveryBtn');
          deliveryBtn.textContent = 'âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ³Ù„ÙŠÙ… - Ø§Ù†Ù‚Ø± Ù„Ù„ØªØ¹Ø¯ÙŠÙ„';
          deliveryBtn.style.background = '#28a745';
          
          updateStatus('success', 'âœ… ØªÙ… Ø­ÙØ¸ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­!');
        }
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¥Ø°Ø§ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ÙŠÙ†
        if (pickupLocation && deliveryLocation) {
          calculateDistance();
        }
        
        closeMap();
      }, 1000);
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    function closeMap() {
      document.getElementById('mapModal').style.display = 'none';
      
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« ÙˆÙ†ØªØ§Ø¦Ø¬Ù‡
      document.getElementById('searchLocation').value = '';
      document.getElementById('searchResults').style.display = 'none';
      document.getElementById('searchResults').innerHTML = '';
      
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯
      const selectedInfo = document.getElementById('selectedLocationInfo');
      selectedInfo.style.display = 'none';
      selectedInfo.style.background = '#e7f3ff';
      selectedInfo.style.border = '1px solid #0077cc';
      
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯
      const confirmBtn = document.getElementById('confirmLocationBtn');
      confirmBtn.style.display = 'none';
      confirmBtn.textContent = 'âœ… ØªØ£ÙƒÙŠØ¯ ÙˆØ­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
      confirmBtn.disabled = false;
      
      // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø±ÙŠØ¹
      const quickConfirmBtn = document.getElementById('quickConfirmBtn');
      quickConfirmBtn.style.display = 'none';
      
      currentMapMode = null;
      selectedMapLocation = null;
      
      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ø°Ø§ÙƒØ±Ø©
      if (map) {
        map.remove();
        map = null;
      }
      currentMarker = null;
    }

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„ÙŠØ¯ÙˆÙŠØ©
    function calculateManualDistance() {
      const pickupAddress = document.getElementById('manualPickupAddress').value;
      const pickupLat = parseFloat(document.getElementById('manualPickupLat').value);
      const pickupLng = parseFloat(document.getElementById('manualPickupLng').value);

      const deliveryAddress = document.getElementById('manualDeliveryAddress').value;
      const deliveryLat = parseFloat(document.getElementById('manualDeliveryLat').value);
      const deliveryLng = parseFloat(document.getElementById('manualDeliveryLng').value);

      if (!pickupAddress || !deliveryAddress || isNaN(pickupLat) || isNaN(pickupLng) || isNaN(deliveryLat) || isNaN(deliveryLng)) {
        updateStatus('error', 'âŒ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
        return;
      }

      pickupLocation = { lat: pickupLat, lng: pickupLng };
      deliveryLocation = { lat: deliveryLat, lng: deliveryLng };

      document.getElementById('pickup').value = pickupAddress;
      document.getElementById('delivery').value = deliveryAddress;

      document.getElementById('pickupInfo').textContent = `âœ… Ù…ÙƒØ§Ù† Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…: ${pickupAddress}`;
      document.getElementById('deliveryInfo').textContent = `âœ… Ù…ÙƒØ§Ù† Ø§Ù„ØªØ³Ù„ÙŠÙ…: ${deliveryAddress}`;

      calculateDistance();
      updateStatus('success', 'âœ… ØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© ÙˆØ§Ù„Ø³Ø¹Ø± Ø¨Ù†Ø¬Ø§Ø­!');
    }

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ù†Ù‚Ø·ØªÙŠÙ†
    function calculateDistance() {
      if (!pickupLocation || !deliveryLocation) {
        return;
      }

      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚Ø§Ù†ÙˆÙ† Haversine
      const R = 6371; // Ù†ØµÙ Ù‚Ø·Ø± Ø§Ù„Ø£Ø±Ø¶ Ø¨Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±
      const dLat = toRad(deliveryLocation.lat - pickupLocation.lat);
      const dLng = toRad(deliveryLocation.lng - pickupLocation.lng);

      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(toRad(pickupLocation.lat)) * Math.cos(toRad(deliveryLocation.lat)) *
                Math.sin(dLng/2) * Math.sin(dLng/2);

      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      const distance = R * c; // Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±

      const distanceKm = distance.toFixed(2);
      document.getElementById('distanceInfo').textContent = `âœ… Ø§Ù„Ù…Ø³Ø§ÙØ©: ${distanceKm} ÙƒÙ…`;

      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø±
      const price = calculatePrice(parseFloat(distanceKm));
      document.getElementById('priceDisplay').textContent = `ğŸ’° Ø§Ù„Ø³Ø¹Ø±: ${price} Ø¬Ù†ÙŠÙ‡`;
    }

    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø¥Ù„Ù‰ Ø±Ø§Ø¯ÙŠØ§Ù†
    function toRad(deg) {
      return deg * (Math.PI/180);
    }

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©
    function calculatePrice(distance) {
      if (!distance || distance <= 0) return 0;
      const basePricePer3km = 28;
      const tax = 10;
      const price = (distance / 3) * basePricePer3km + tax;
      return Math.round(price);
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
    function sendOrder() {
      const pickup = document.getElementById('pickup').value.trim();
      const delivery = document.getElementById('delivery').value.trim();
      const description = document.getElementById('description').value.trim();

      // Ø¬Ù…Ø¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…
      const pickupFloor = document.getElementById('pickupFloor').value.trim();
      const pickupApartment = document.getElementById('pickupApartment').value.trim();
      const pickupDetails = document.getElementById('pickupDetails').value.trim();

      // Ø¬Ù…Ø¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ³Ù„ÙŠÙ…
      const deliveryFloor = document.getElementById('deliveryFloor').value.trim();
      const deliveryApartment = document.getElementById('deliveryApartment').value.trim();
      const deliveryDetails = document.getElementById('deliveryDetails').value.trim();

      if (!pickupLocation || !deliveryLocation) {
        alert('âš ï¸ ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… ÙˆØ§Ù„ØªØ³Ù„ÙŠÙ… Ø£ÙˆÙ„Ø§Ù‹!');
        return;
      }

      if (!pickup || !delivery || !description) {
        alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
        return;
      }

      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶
      const distanceText = document.getElementById('distanceInfo').textContent;
      const distanceMatch = distanceText.match(/(\d+\.?\d*)\s*ÙƒÙ…/);
      const distance = distanceMatch ? parseFloat(distanceMatch[1]) : 0;

      if (distance <= 0) {
        alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
        return;
      }

      const price = calculatePrice(distance);

      // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      const userName = localStorage.getItem('userName');
      const userPhone = localStorage.getItem('userPhone');

      if (!userName || !userPhone) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
        window.location.href = 'user-register.html';
        return;
      }

      // Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ localStorage
      let orders = JSON.parse(localStorage.getItem('orders') || '[]');

      const order = {
        id: 'order-' + Date.now(),
        userName,
        userPhone,
        pickup,
        delivery,
        description,
        distance,
        price,
        status: 'pending',
        captainName: '',
        captainPhone: '',
        createdAt: new Date().toISOString(),
        pickupCoords: {
          lat: pickupLocation.lat,
          lng: pickupLocation.lng
        },
        deliveryCoords: {
          lat: deliveryLocation.lat,
          lng: deliveryLocation.lng
        },
        pickupDetails: {
          floor: pickupFloor,
          apartment: pickupApartment,
          additionalInfo: pickupDetails
        },
        deliveryDetails: {
          floor: deliveryFloor,
          apartment: deliveryApartment,
          additionalInfo: deliveryDetails
        }
      };

      orders.push(order);
      localStorage.setItem('orders', JSON.stringify(orders));

      alert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!');

      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
      resetForm();
    }

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    function resetForm() {
      document.getElementById('pickup').value = '';
      document.getElementById('delivery').value = '';
      document.getElementById('description').value = '';
      
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…
      document.getElementById('pickupFloor').value = '';
      document.getElementById('pickupApartment').value = '';
      document.getElementById('pickupDetails').value = '';
      
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ³Ù„ÙŠÙ…
      document.getElementById('deliveryFloor').value = '';
      document.getElementById('deliveryApartment').value = '';
      document.getElementById('deliveryDetails').value = '';
      
      document.getElementById('priceDisplay').textContent = 'Ø§Ù„Ø³Ø¹Ø±: 0 Ø¬Ù†ÙŠÙ‡';
      document.getElementById('pickupInfo').textContent = 'Ù…ÙƒØ§Ù† Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…: ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      document.getElementById('deliveryInfo').textContent = 'Ù…ÙƒØ§Ù† Ø§Ù„ØªØ³Ù„ÙŠÙ…: ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      document.getElementById('distanceInfo').textContent = 'Ø§Ù„Ù…Ø³Ø§ÙØ©: ØºÙŠØ± Ù…Ø­Ø³ÙˆØ¨Ø©';

      // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
      document.getElementById('autoLocationSection').style.display = 'none';
      document.getElementById('manualLocationSection').classList.remove('show');
      document.getElementById('autoLocationBtn').classList.remove('active');
      document.getElementById('manualLocationBtn').classList.remove('active');

      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ø²Ø±Ø§Ø±
      document.getElementById('pickupBtn').textContent = 'ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ';
      document.getElementById('pickupBtn').style.background = '#28a745';
      document.getElementById('deliveryBtn').textContent = 'ğŸ¯ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ³Ù„ÙŠÙ…';
      document.getElementById('deliveryBtn').style.background = '#28a745';
      document.getElementById('deliveryBtn').onclick = enableDeliverySelection;

      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
      pickupLocation = null;
      deliveryLocation = null;
      isDeliverySelectionEnabled = false;

      updateStatus('warning', 'Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø£Ø¹Ù„Ø§Ù‡');
    }
  </script>
</body>
</html>