<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙƒØ§Ø¨ØªÙ† - Ø·ÙŠØ§Ø±</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: auto;
      padding: 20px;
      background: #f0f8ff;
    }
    h2 {
      text-align: center;
      color: #0077cc;
      margin-bottom: 20px;
    }
    .order {
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 8px #ccc;
      margin-bottom: 15px;
      padding: 15px;
      direction: rtl;
      text-align: right;
    }
    .order.pending {
      border-left: 6px solid #0077cc;
    }
    .order.accepted {
      border-left: 6px solid #28a745;
      background: #e6f4ea;
    }
    button {
      background: #0077cc;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background: #005a99;
    }
    .logout-btn {
      margin-bottom: 20px;
      background: #d9534f;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      float: left;
    }
    .logout-btn:hover {
      background: #c9302c;
    }
    .notification {
      background: #0077cc;
      color: white;
      padding: 10px;
      border-radius: 6px;
      text-align: center;
      margin-bottom: 15px;
      display: none;
    }
  </style>
</head>
<body>
  <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
    <button class="logout-btn" id="logoutBtn">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    <button onclick="window.location.href='wallet.html'" style="background: #28a745; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer;">ğŸ’° Ø§Ù„Ù…Ø­ÙØ¸Ø©</button>
  </div>
  <h2>Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„ Ù„Ù„ÙƒØ§Ø¨ØªÙ†</h2>

  <div id="notification" class="notification">ÙˆØµÙ„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯!</div>

  <div id="ordersContainer"></div>

  <script>
    const logoutBtn = document.getElementById('logoutBtn');
    const ordersContainer = document.getElementById('ordersContainer');
    const notification = document.getElementById('notification');

    logoutBtn.onclick = () => {
      localStorage.removeItem('captainName');
      localStorage.removeItem('captainPhone');
      window.location.href = 'captain-login_1750026768731.html';
    };

    // Ù†Ø·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙƒØ§Ø¨ØªÙ† Ø£ÙˆÙ„Ø§Ù‹
    function checkLogin() {
      const captainName = localStorage.getItem('captainName');
      const captainPhone = localStorage.getItem('captainPhone');
      if (!captainName || !captainPhone) {
        window.location.href = 'captain-login_1750026768731.html';
      }
      return { captainName, captainPhone };
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
    function renderOrders() {
      let orders = JSON.parse(localStorage.getItem('orders') || '[]');
      const { captainName, captainPhone } = checkLogin();

      // Ø§Ù„ÙÙ„Ø§ØªØ±:
      // Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (pending) Ø£Ùˆ Ø§Ù„Ù„ÙŠ Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ø§Ø³ØªÙ„Ù…Ù‡Ø§ (accepted) Ù„Ù‡
      orders = orders.filter(o => o.status === 'pending' || (o.status === 'accepted' && o.captainPhone === captainPhone));

      ordersContainer.innerHTML = '';

      if (orders.length === 0) {
        ordersContainer.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>';
        return;
      }

      orders.forEach(order => {
        const div = document.createElement('div');
        div.className = 'order ' + order.status;

        div.innerHTML = `
          <p><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${order.userName} (${order.userPhone})</p>
          <p><strong>Ù…ÙƒØ§Ù† Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…:</strong> ${order.pickup}</p>
          <p><strong>Ù…ÙƒØ§Ù† Ø§Ù„ØªØ³Ù„ÙŠÙ…:</strong> ${order.delivery}</p>
          <p><strong>Ø§Ù„ÙˆØµÙ:</strong> ${order.description}</p>
          <p><strong>Ø§Ù„Ø³Ø¹Ø±:</strong> ${order.price} Ø¬Ù†ÙŠÙ‡</p>
          <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${order.status === 'pending' ? 'Ø¬Ø¯ÙŠØ¯' : 'Ù…Ù‚Ø¨ÙˆÙ„'}</p>
        `;

        if (order.status === 'pending') {
          const btnAccept = document.createElement('button');
          btnAccept.textContent = 'Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨';
          btnAccept.onclick = () => acceptOrder(order.id);
          div.appendChild(btnAccept);
        } else {
          div.innerHTML += `<p><strong>Ø§Ù„ÙƒØ§Ø¨ØªÙ†:</strong> ${order.captainName} (${order.captainPhone})</p>`;
          const chatBtn = document.createElement('button');
          chatBtn.textContent = 'ğŸ’¬ ÙØªØ­ Ø§Ù„Ø´Ø§Øª';
          chatBtn.style.background = '#28a745';
          chatBtn.style.marginTop = '10px';
          chatBtn.onclick = () => openChat(order.id);
          div.appendChild(chatBtn);
        }

        ordersContainer.appendChild(div);
      });
    }

    // Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨
    function acceptOrder(orderId) {
      const { captainName, captainPhone } = checkLogin();
      let orders = JSON.parse(localStorage.getItem('orders') || '[]');

      const index = orders.findIndex(o => o.id === orderId);
      if (index === -1) return alert('Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');

      if (orders[index].status !== 'pending') return alert('Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ ØªÙ… Ù‚Ø¨ÙˆÙ„Ù‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹');

      orders[index].status = 'accepted';
      orders[index].captainName = captainName;
      orders[index].captainPhone = captainPhone;

      localStorage.setItem('orders', JSON.stringify(orders));
      alert('ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨');
      renderOrders();
    }

    // Ø¥Ø´Ø¹Ø§Ø± ØµÙˆØªÙŠ ÙˆÙ…Ø±Ø¦ÙŠ Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
    let previousOrdersCount = 0;
    function checkNewOrders() {
      let orders = JSON.parse(localStorage.getItem('orders') || '[]');
      const pendingOrders = orders.filter(o => o.status === 'pending').length;

      if (pendingOrders > previousOrdersCount) {
        // Ø¬Ø¯ÙŠØ¯ Ø·Ù„Ø¨ ÙˆØµÙ„
        notification.style.display = 'block';
        playNotificationSound();
        setTimeout(() => {
          notification.style.display = 'none';
        }, 4000);
      }

      previousOrdersCount = pendingOrders;
    }

    function playNotificationSound() {
      const audio = new Audio('https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg');
      audio.play();
    }

    // ÙØªØ­ Ø§Ù„Ø´Ø§Øª Ù„Ù„Ø·Ù„Ø¨
    function openChat(orderId) {
      window.location.href = `chat.html?orderId=${orderId}`;
    }

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙˆØ±ÙŠ
    function startPolling() {
      renderOrders();
      checkNewOrders();
      setInterval(() => {
        renderOrders();
        checkNewOrders();
      }, 5000);
    }

    // ØªÙ†ÙÙŠØ° Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    window.onload = () => {
      checkLogin();
      startPolling();
    };
  </script>
</body>
</html>